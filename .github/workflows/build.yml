name: Build Android Debug APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        submodules: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install prerequisites from file
      run: |
        sudo apt-get update
        # Install APT packages (lines without ==)
        grep -v '^#' prerequisites.txt | grep -v '^$' | grep -v '==' | xargs sudo apt-get install -y
        # Install Python packages (lines with == or no apt-style name)
        grep -v '^#' prerequisites.txt | grep -v '^$' | grep -E '==' | xargs pip install

    - name: Clean pyjnius build artifacts
      run: |
        buildozer android clean --recipe pyjnius || true

    - name: Apply pyjnius long fix patch
      run: |
        patch -p1 -d "${GITHUB_WORKSPACE}/.buildozer/android/platform/build-arm64-v8a/build/other_builds/pyjnius-sdl2/arm64-v8a__ndk_target_24/pyjnius" < pyjnius_long_fix.patch || true

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Install Android SDK Build Tools and Platform Tools
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p "$ANDROID_HOME"

        wget -q "https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip" -O /tmp/commandlinetools.zip
        unzip -q /tmp/commandlinetools.zip -d "$ANDROID_HOME/cmdline-tools"
        mv "$ANDROID_HOME/cmdline-tools/cmdline-tools" "$ANDROID_HOME/cmdline-tools/latest"

        mkdir -p "$ANDROID_HOME/tools/bin"
        ln -sf "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_HOME/tools/bin/sdkmanager"

        yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" --licenses || true

        "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_HOME" \
          "build-tools;34.0.0" \
          "platforms;android-35" \
          "platform-tools" \
          "ndk;25.1.8937393"

    - name: Set Android Environment Variables
      run: |
        echo "ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH

    - name: Clean buildozer cache
      run: rm -rf .buildozer

    - name: Build debug APK
      run: |
        mkdir -p logs
        buildozer -v android debug | tee logs/buildozer-output.log

    - name: Upload APK Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: webview-app-debug-apk
        path: bin/*.apk

    - name: Upload Terminal Output Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: buildozer-output-log
        path: logs/buildozer-output.log
